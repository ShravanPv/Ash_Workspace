from datetime import datetime

from sqlalchemy import Column, Integer, Sequence, String, DateTime, Boolean, \
    UniqueConstraint, ForeignKey, text
from sqlalchemy.dialects.postgresql import JSONB

from fusion_models.tenant.base import ClientBase


class MappingRule(ClientBase):
    __tablename__ = 'mapping_rules'

    id = Column(Integer, Sequence('mapping_rules_id_seq'), primary_key=True)

    name = Column(String(64), nullable=False)
    description = Column(String(512))

    source_view_id = Column(Integer, ForeignKey('source_views.id'),
                            nullable=False)
    oracle_fbdi_csv_type_id = Column(Integer, nullable=False)

    mapping_type_id = Column(Integer, nullable=False)

    created_on = Column(DateTime, server_default=text('(now() at time zone '
                                                      '\'utc\')'))
    modified_on = Column(DateTime, onupdate=datetime.utcnow)
    modified_by = Column(Integer, nullable=False)

    __table_args__ = (
        UniqueConstraint('name', name='_mapping_rules_name_uc'),
        UniqueConstraint(
            'source_view_id', 'oracle_fbdi_csv_type_id', 'mapping_type_id',
            name='_m_rules_view_id_fbdi_csv_type_id_mapping_type_id_uc'
        ),
    )


class DirectMappingRuleAttribute(ClientBase):
    __tablename__ = 'direct_mapping_attributes'

    id = Column(Integer, Sequence('direct_mapping_attributes_id_seq'),
                primary_key=True)

    mapping_rule_id = Column(Integer, ForeignKey('mapping_rules.id'),
                             nullable=False)
    view_field_name = Column(String, nullable=False)
    oracle_fbdi_csv_field_meta_id = Column(Integer, nullable=False)

    created_on = Column(DateTime, server_default=text('(now() at time zone '
                                                      '\'utc\')'))
    modified_on = Column(DateTime, onupdate=datetime.utcnow)
    modified_by = Column(Integer, nullable=False)

    __table_args__ = (
        UniqueConstraint(
            'mapping_rule_id', 'oracle_fbdi_csv_field_meta_id',
            name='_direct_mapping_attr_rule_id_fbdi_csv_field_id_uc'
        ),
    )


class DefaultMappingRuleAttribute(ClientBase):
    __tablename__ = 'default_mapping_attributes'

    id = Column(Integer, Sequence('default_mapping_attributes_id_seq'),
                primary_key=True)

    mapping_rule_id = Column(Integer, ForeignKey('mapping_rules.id'),
                             nullable=False)
    oracle_fbdi_csv_field_meta_id = Column(Integer, nullable=False)
    default_value = Column(JSONB, nullable=False)

    created_on = Column(DateTime, server_default=text('(now() at time zone '
                                                      '\'utc\')'))
    modified_on = Column(DateTime, onupdate=datetime.utcnow)
    modified_by = Column(Integer, nullable=False)

    __table_args__ = (
        UniqueConstraint(
            'mapping_rule_id', 'oracle_fbdi_csv_field_meta_id',
            name='_default_mapping_attr_rule_id_fbdi_csv_field__id_uc'
        ),
    )


class CompositeMappingRule(ClientBase):
    __tablename__ = 'composite_mapping_rules'

    id = Column(Integer, Sequence('composite_mapping_rules_id_seq'),
                primary_key=True)

    mapping_rule_id = Column(Integer, ForeignKey('mapping_rules.id'),
                             nullable=False)
    grid_id = Column(Integer, ForeignKey('grids.id'), nullable=False)

    created_on = Column(DateTime, server_default=text('(now() at time zone '
                                                      '\'utc\')'))
    modified_on = Column(DateTime, onupdate=datetime.utcnow)
    modified_by = Column(Integer, nullable=False)


class CompositeMappingRuleAttribute(ClientBase):
    __tablename__ = 'composite_mapping_rule_attributes'

    id = Column(Integer, Sequence('composite_mapping_rule_attributes_id_seq'),
                primary_key=True)

    composite_mapping_rule_id = Column(Integer, ForeignKey(
        'composite_mapping_rules.id'), nullable=False)
    view_field_name = Column(String(32))
    oracle_fbdi_csv_field_meta_id = Column(Integer)
    type = Column(String(32), nullable=False)
    grid_field_id = Column(Integer, ForeignKey('grid_fields.id'),
                           nullable=False)

    created_on = Column(DateTime, server_default=text('(now() at time zone '
                                                      '\'utc\')'))
    modified_on = Column(DateTime, onupdate=datetime.utcnow)
    modified_by = Column(Integer, nullable=False)

    __table_args__ = (
        UniqueConstraint(
            'composite_mapping_rule_id', 'view_field_name',
            name='_composite_mapping_attr_com_rule_id_view_field_name_uc'
        ),
        UniqueConstraint(
            'composite_mapping_rule_id', 'grid_field_id',
            name='_composite_mapping_attr_com_rule_id_grid_field_id_uc'
        ),
        UniqueConstraint(
            'composite_mapping_rule_id', 'oracle_fbdi_csv_field_meta_id',
            name='_comp_map_attr_rule_id_oracle_fbdi_csv_field_meta_id_uc'
        ),
    )


class RuleMetadata(ClientBase):
    __tablename__ = 'rule_metadata'

    id = Column(Integer, Sequence('rule_metadata_id_seq'),
                primary_key=True)
    rule_id = Column(Integer, ForeignKey('mapping_rules.id'), nullable=False)
    meta = Column(JSONB, nullable=False)

    created_on = Column(DateTime, server_default=text('(now() at time zone '
                                                      '\'utc\')'))
    modified_by = Column(Integer, nullable=False)
    are_attrs_empty = Column(Boolean, nullable=False)
    modified_on = Column(DateTime, onupdate=datetime.utcnow)


class NullableFBDIRuleAttribute(ClientBase):
    __tablename__ = 'nullable_fbdi_rule_attributes'

    id = Column(Integer, Sequence('nullable_fbdi_rule_attributes_id_seq'),
                primary_key=True)
    mapping_rule_id = Column(Integer, ForeignKey('mapping_rules.id'),
                             nullable=False)
    oracle_fbdi_csv_field_meta_id = Column(Integer, nullable=False)
    nullable = Column(Boolean, nullable=False)

    created_on = Column(DateTime, server_default=text('(now() at time zone '
                                                      '\'utc\')'))
    modified_on = Column(DateTime, onupdate=datetime.utcnow)
    modified_by = Column(Integer, nullable=False)

    __table_args__ = (
        UniqueConstraint(
            'mapping_rule_id', 'oracle_fbdi_csv_field_meta_id',
            name='_rule_id_field_meta_id_uc'
        ),
    )
